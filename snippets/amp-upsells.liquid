<script>

const updateCartBubbleCount = (count) => {
  const cartCountEls = document.querySelectorAll(".header__cart__status");
  for (const cc of cartCountEls) {
    cc.setAttribute("data-cart-count", count);
    cc.innerText = count;

    if (count > 0) {
      cc.style.display = 'inline-flex';
      cc.style.justifyContent = 'center';
    } else {
      cc.style.display = 'none';
    }
  }  
};

const updateTickerBarFreeShippingMessage = (cart) => {
  const tickerBar = document.querySelector('ticker-bar');
  if (!tickerBar) return;

  const freeShippingEle = tickerBar.querySelector('.free-shipping');
  if (!freeShippingEle) return;

  const freeShippingLimit = parseInt(freeShippingEle.dataset.freeShippingLimit)
  const allLeftToSpendMsgs = tickerBar.querySelectorAll('[data-left-to-spend]');

  if (freeShippingEle.dataset.freeShipping === 'true') {
    if (!cart || !cart.total_price) {
      freeShippingEle.classList.remove('is-success');
      allLeftToSpendMsgs.forEach(el => {
        if (el) {
          el.innerText = `$${freeShippingLimit}`;
        }
      });
      return;
    }
    
    const subtotal = cart.total_price / 100;
    const leftToSpend = Math.min(freeShippingLimit - subtotal, freeShippingLimit);
    
    if (leftToSpend <= 0) {
      freeShippingEle.classList.add('is-success');
    } else {
      freeShippingEle.classList.remove('is-success');
      allLeftToSpendMsgs.forEach(el => {
        if (el) {
          el.innerText = `$${leftToSpend.toFixed(2).replace('.00', '')}`;
        }
      });
    }
  }
  
};
  
document.addEventListener("click", function (event) {
    event.stopImmediatePropagation(event);
    const button = event.target.closest("form[action='/cart/add'] button.btn--primary, form[action='/cart/add'] button.btn--primary *");
        if (button) {
            console.log("clicked")
            try {
                setTimeout(function () {
                window.AMP_API.OPEN_CART()
                }, 600);

            } catch (err) {
            console.error(err);
            }
        }
    },
    false
);  

window.AMP_CART_UPDATED = function(cart) {
  updateTickerBarFreeShippingMessage(cart);
  updateCartBubbleCount(cart.item_count);
};
</script>